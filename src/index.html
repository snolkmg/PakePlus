<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>å›¾ç‰‡é¢œè‰²æå–å™¨</title>

  <!-- ViewerJS CSS -->
<link rel="stylesheet" href="./viewerjs-1.11.7/viewer.min.css">
<script src="./viewerjs-1.11.7/viewer.min.js"></script>
  <style>
    :root {
      --bg-color: #f8f9fa;
      --text-color: #333;
      --card-bg: #fff;
      --border-color: #ddd;
      --primary-color: #409EFF;
      --primary-hover: #307ae0;
    }
    /* è‡ªåŠ¨è·Ÿéšç³»ç»Ÿæ·±è‰² */
    @media (prefers-color-scheme: dark) {
      body:not(.dark) {
        --bg-color: #121212;
        --text-color: #eee;
        --card-bg: #1e1e1e;
        --border-color: #333;
        --primary-color: #409EFF;
        --primary-hover: #66b1ff;
      }
    }
    /* æ‰‹åŠ¨å¼ºåˆ¶æš—æ¨¡å¼ï¼Œä¼˜å…ˆçº§æœ€é«˜ */
    body.dark {
      --bg-color: #121212;
      --text-color: #eee;
      --card-bg: #1e1e1e;
      --border-color: #333;
      --primary-color: #409EFF;
      --primary-hover: #66b1ff;
    }

    * {
      box-sizing: border-box;
    }

    body {
      background: var(--bg-color);
      color: var(--text-color);
      font-family: "Segoe UI", Roboto, "Helvetica Neue", sans-serif;
      padding: 20px;
      margin: 0 auto;
      max-width: 900px;
    }

    h2 {
      text-align: justify;
      margin-bottom: 30px;
    }

    /* å¤œé—´æ¨¡å¼åˆ‡æ¢æŒ‰é’®ï¼šå›¾æ ‡å½¢å¼ */
    #toggleDarkBtn {
      font-size: 24px;
      width: 40px;
      height: 40px;
      padding: 0;
      line-height: 1;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      float: right;
      margin-bottom: 0;
      background: var(--primary-color);
      color: white;
      user-select: none;
      transition: background-color 0.3s;
    }
    #toggleDarkBtn:hover {
      background: var(--primary-hover);
    }

    .upload-area {
      border: 2px dashed var(--border-color);
      background: var(--card-bg);
      padding: 50px 20px;
      text-align: center;
      border-radius: 12px;
      cursor: pointer;
      transition: border-color 0.3s;
      margin-bottom: 30px;
      user-select: none;
    }

    .upload-area:hover {
      border-color: var(--primary-color);
    }

    input[type="file"] {
      display: none;
    }

    .url-input-area {
      text-align: center;
      margin-bottom: 20px;
      clear: both;
    }

    .url-input-area input {
      width: 70%;
      max-width: 500px;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid var(--border-color);
      background: var(--card-bg);
      color: var(--text-color);
    }

    .url-input-area input:focus {
      outline: none;
      border-color: var(--primary-color);
    }

    .url-input-area button {
      padding: 8px 14px;
      margin-left: 10px;
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }

    .url-input-area button:hover {
      background: var(--primary-hover);
    }

    .image-container {
      padding: 20px;
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      margin-bottom: 30px;
      text-align: center;
    }

    .image-container img {
      max-width: 100%;
      max-height: 400px;
      display: inline-block;
      border-radius: 10px;
      cursor: zoom-in;
    }

    .section {
      margin-top: 30px;
    }

    .color-section-box {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 30px;
    }

    .color-block {
      width: 120px;
      margin: 10px 10px 20px 0;
      padding: 8px 12px;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      transition: transform 0.2s;
      user-select: none;
      background-clip: padding-box;
      display: inline-block;
      vertical-align: top;
      text-align: center;
      color: white; /* é»˜è®¤è‰²ï¼Œåé¢ä¼šåŠ¨æ€è¦†ç›– */
    }
    .color-block:hover {
      transform: scale(1.05);
    }
    .color-block div {
      line-height: 1.3;
      font-size: 12px;
      user-select: text;
    }

    .count-control {
      text-align: center;
      margin-bottom: 20px;
    }

    .count-control input {
      width: 60px;
      padding: 6px;
      text-align: center;
      border-radius: 6px;
      border: 1px solid var(--border-color);
      background: var(--card-bg);
      color: var(--text-color);
    }

    .count-control button {
      padding: 6px 12px;
      margin-left: 10px;
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }

    .count-control button:hover {
      background: var(--primary-hover);
    }

    button {
      padding: 6px 12px;
      margin-right: 0;
      border-radius: 6px;
      border: none;
      background: var(--primary-color);
      color: white;
      cursor: pointer;
    }

    button:hover {
      background: var(--primary-hover);
    }

    /* è°ƒè‰²æ¿å®¹å™¨ï¼Œå¼¹æ€§å¸ƒå±€ */
    .palette {
      display: flex;
      flex-wrap: wrap;
	  justify-content: center;
    }

    /* å†å²è®°å½•åŒºåŸŸ */
    .history-section {
      margin-top: 40px;
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 20px;
      clear: both;
    }

    #historyList {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-top: 10px;
    }

    .history-item {
      width: 140px;
      background: var(--bg-color);
      border: 1px solid var(--border-color);
      border-radius: 10px;
      padding: 8px;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      user-select: none;
      transition: transform 0.15s;
      text-align: center;
    }

    .history-item:hover {
      transform: scale(1.05);
    }

    .history-item img {
      width: 100%;
      height: 80px;
      object-fit: contain;
      border-radius: 6px;
      margin-bottom: 6px;
    }

    .history-palette {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      justify-content: center;
    }

    .history-color-block {
      width: 18px;
      height: 18px;
      border-radius: 4px;
    }
	
	.export-buttons {
		margin-top: 10px;
		display: flex;
		gap: 10px;
	}
	
	.export-buttons button {
		margin-bottom: 10px;
	}

    /* å“åº”å¼é€‚é… */
    @media screen and (max-width: 600px) {
      .url-input-area input {
        width: 65%;
      }

      .color-block {
        width: 90px;
        padding: 6px 8px;
        font-size: 11px;
      }

      .upload-area {
        padding: 30px 15px;
        font-size: 16px;
      }

      #historyList {
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <button id="toggleDarkBtn" aria-label="åˆ‡æ¢å¤œé—´æ¨¡å¼" title="åˆ‡æ¢å¤œé—´æ¨¡å¼">ğŸŒ™</button>

  <h2>å›¾ç‰‡é¢œè‰²æå–å™¨</h2>

  <!-- ä¸Šä¼ åŒºåŸŸ -->
  <div class="upload-area" id="uploadArea" tabindex="0" aria-label="ç‚¹å‡»æˆ–æ‹–æ”¾å›¾ç‰‡ä¸Šä¼ ">
    ç‚¹å‡»æˆ–æ‹–æ”¾å›¾ç‰‡åˆ°æ­¤åŒºåŸŸä¸Šä¼ 
    <input type="file" id="fileInput" accept="image/*" />
  </div>

  <!-- è¿œç¨‹å›¾ç‰‡é“¾æ¥è¾“å…¥ -->
  <div class="url-input-area">
    <input
      type="text"
      id="imageUrlInput"
      placeholder="ç²˜è´´ç½‘ç»œå›¾ç‰‡é“¾æ¥ï¼ˆæ”¯æŒ http/httpsï¼‰"
      aria-label="ç½‘ç»œå›¾ç‰‡é“¾æ¥è¾“å…¥æ¡†"
    />
    <button id="loadUrlBtn">åŠ è½½å›¾ç‰‡</button>
  </div>

  <!-- å›¾ç‰‡é¢„è§ˆ -->
  <div class="image-container" id="imageContainer" style="display:none;">
    <img id="previewImage" crossorigin="anonymous" alt="å›¾ç‰‡é¢„è§ˆ" />
  </div>

  <!-- è°ƒè‰²æ¿æ•°é‡è®¾ç½® -->
  <div class="count-control" id="countSection" style="display:none;">
    <label for="paletteCountInput">è°ƒè‰²æ¿æ•°é‡: </label>
    <input
      type="number"
      id="paletteCountInput"
      min="1"
      max="64"
      value="16"
      aria-label="è°ƒè‰²æ¿é¢œè‰²æ•°é‡"
    />
    <button id="extractBtn">æå–é¢œè‰²</button>
  </div>

  <!-- ä¸»è‰²æ˜¾ç¤º -->
  <div class="color-section-box" id="mainColorSection" style="display:none;">
    <h3>ä¸»è‰²</h3>
    <div id="mainColor"></div>
  </div>

  <!-- è°ƒè‰²æ¿æ˜¾ç¤º -->
  <div class="color-section-box" id="paletteSection" style="display:none;">
    <h3>è°ƒè‰²æ¿</h3>
    <div class="palette" id="palette"></div>
    <div class="export-buttons">
      <button id="exportJsonBtn">å¯¼å‡º JSON</button>
      <button id="exportPngBtn">å¯¼å‡º PNG</button>
      <button id="exportSvgBtn">å¯¼å‡º SVG</button>
    </div>
  </div>

  <!-- å†å²è®°å½• -->
  <div class="history-section">
    <h3>å†å²è®°å½•</h3>
    <button id="clearHistoryBtn">æ¸…é™¤å†å²</button>
    <div id="historyList"></div>
  </div>

  <!-- color-thief -->
<script src="./color-thief-2.6.0/color-thief.min.js"></script>

  <script>
    const uploadArea = document.getElementById("uploadArea");
    const fileInput = document.getElementById("fileInput");
    const previewImage = document.getElementById("previewImage");
    const imageContainer = document.getElementById("imageContainer");
    const countSection = document.getElementById("countSection");
    const paletteCountInput = document.getElementById("paletteCountInput");
    const extractBtn = document.getElementById("extractBtn");
    const mainColorSection = document.getElementById("mainColorSection");
    const mainColorDiv = document.getElementById("mainColor");
    const paletteSection = document.getElementById("paletteSection");
    const paletteDiv = document.getElementById("palette");
    const imageUrlInput = document.getElementById("imageUrlInput");
    const loadUrlBtn = document.getElementById("loadUrlBtn");
    const exportJsonBtn = document.getElementById("exportJsonBtn");
    const exportPngBtn = document.getElementById("exportPngBtn");
    const exportSvgBtn = document.getElementById("exportSvgBtn");
    const toggleDarkBtn = document.getElementById("toggleDarkBtn");
    const historyListEl = document.getElementById("historyList");
    const clearHistoryBtn = document.getElementById("clearHistoryBtn");

    let viewer = null;
    let palette = [];
    let mainColor = null;
    const colorThief = new ColorThief();

    // === å¤œé—´æ¨¡å¼æŒ‰é’®å’Œé€»è¾‘ ===
    function updateButtonIcon() {
      const isDark = document.body.classList.contains("dark");
      toggleDarkBtn.textContent = isDark ? "â˜€ï¸" : "ğŸŒ™";
      toggleDarkBtn.title = isDark ? "åˆ‡æ¢åˆ°æ—¥é—´æ¨¡å¼" : "åˆ‡æ¢åˆ°å¤œé—´æ¨¡å¼";
    }

    toggleDarkBtn.addEventListener("click", () => {
      document.body.classList.toggle("dark");
      const isDark = document.body.classList.contains("dark");
      localStorage.setItem("darkMode", isDark);
      updateButtonIcon();
    });

    // åˆå§‹è¯»å–å¤œé—´æ¨¡å¼è®¾ç½®
    if (localStorage.getItem("darkMode") === "true") {
      document.body.classList.add("dark");
    } else if (localStorage.getItem("darkMode") === "false") {
      document.body.classList.remove("dark");
    }
    updateButtonIcon();

    // === äº®åº¦åˆ¤æ–­å‡½æ•°ï¼ˆå†³å®šæ–‡å­—é¢œè‰²ï¼‰ ===
    function getLuminance(r, g, b) {
      const a = [r, g, b].map((v) => {
        v /= 255;
        return v <= 0.03928
          ? v / 12.92
          : Math.pow((v + 0.055) / 1.055, 2.4);
      });
      return 0.2126 * a[0] + 0.7152 * a[1] + 0.0722 * a[2];
    }

    function getTextColor(r, g, b) {
      return getLuminance(r, g, b) > 0.5 ? "#000" : "#fff";
    }

    // === å·¥å…·å‡½æ•°ï¼šrgbæ•°ç»„è½¬hex ===
    function rgbToHex(r, g, b) {
      return (
        "#" +
        [r, g, b]
          .map((x) => {
            const hex = x.toString(16);
            return hex.length === 1 ? "0" + hex : hex;
          })
          .join("")
      );
    }

    // === å·¥å…·å‡½æ•°ï¼šhexè½¬rgb ===
    function hexToRgb(hex) {
      hex = hex.replace(/^#/, "");
      if (hex.length === 3) {
        hex = hex
          .split("")
          .map((x) => x + x)
          .join("");
      }
      const num = parseInt(hex, 16);
      return [(num >> 16) & 255, (num >> 8) & 255, num & 255];
    }

    // === å·¥å…·å‡½æ•°ï¼šrgbè½¬HSV ===
    function rgbToHsv(r, g, b) {
      r /= 255;
      g /= 255;
      b /= 255;

      const max = Math.max(r, g, b),
        min = Math.min(r, g, b);
      let h,
        s,
        v = max;

      const d = max - min;
      s = max === 0 ? 0 : d / max;

      if (max === min) {
        h = 0; // achromatic
      } else {
        switch (max) {
          case r:
            h = (g - b) / d + (g < b ? 6 : 0);
            break;
          case g:
            h = (b - r) / d + 2;
            break;
          case b:
            h = (r - g) / d + 4;
            break;
        }
        h /= 6;
      }

      return [h * 360, s * 100, v * 100];
    }

    // === å·¥å…·å‡½æ•°ï¼šrgbè½¬Lab ===
    function rgbToXyz(r, g, b) {
      r /= 255;
      g /= 255;
      b /= 255;

      r = r > 0.04045 ? Math.pow((r + 0.055) / 1.055, 2.4) : r / 12.92;
      g = g > 0.04045 ? Math.pow((g + 0.055) / 1.055, 2.4) : g / 12.92;
      b = b > 0.04045 ? Math.pow((b + 0.055) / 1.055, 2.4) : b / 12.92;

      const x = r * 0.4124 + g * 0.3576 + b * 0.1805;
      const y = r * 0.2126 + g * 0.7152 + b * 0.0722;
      const z = r * 0.0193 + g * 0.1192 + b * 0.9505;

      return [x * 100, y * 100, z * 100];
    }

    function xyzToLab(x, y, z) {
      const refX = 95.047,
        refY = 100.0,
        refZ = 108.883;

      x /= refX;
      y /= refY;
      z /= refZ;

      x = x > 0.008856 ? Math.pow(x, 1 / 3) : 7.787 * x + 16 / 116;
      y = y > 0.008856 ? Math.pow(y, 1 / 3) : 7.787 * y + 16 / 116;
      z = z > 0.008856 ? Math.pow(z, 1 / 3) : 7.787 * z + 16 / 116;

      const L = 116 * y - 16;
      const a = 500 * (x - y);
      const b = 200 * (y - z);

      return [L, a, b];
    }

    function rgbToLab(r, g, b) {
      const [x, y, z] = rgbToXyz(r, g, b);
      return xyzToLab(x, y, z);
    }

    // === é¢œè‰²æ¸²æŸ“ ===
    function renderMainColor(rgb) {
      mainColorDiv.innerHTML = "";
      const hex = rgbToHex(...rgb);
      const textColor = getTextColor(...rgb);

      const block = document.createElement("div");
      block.className = "color-block";
      block.style.backgroundColor = hex;
      block.style.width = "200px";
      block.style.margin = "0 auto";
      block.style.color = textColor;

      // æ˜¾ç¤ºé¢œè‰²å€¼ï¼ˆHEX/RGB/HSV/Labï¼‰
      const hsv = rgbToHsv(...rgb);
      const lab = rgbToLab(...rgb);

      const infoDiv = document.createElement("div");
      infoDiv.style.fontSize = "14px";
      infoDiv.style.marginTop = "6px";
      infoDiv.innerHTML =
        `<div><b>HEX:</b> ${hex.toUpperCase()}</div>` +
        `<div><b>RGB:</b> ${rgb.join(", ")}</div>` +
        `<div><b>HSV:</b> ${hsv.map((v) => v.toFixed(1)).join(", ")}</div>` +
        `<div><b>Lab:</b> ${lab.map((v) => v.toFixed(1)).join(", ")}</div>`;

      block.appendChild(infoDiv);
      mainColorDiv.appendChild(block);

      // ç‚¹å‡»å¤åˆ¶ä¸»è‰²HEX
      block.title = "ç‚¹å‡»å¤åˆ¶ä¸»è‰² HEX";
      block.style.cursor = "pointer";
      block.onclick = () => {
        navigator.clipboard.writeText(hex.toUpperCase());
        alert(`å·²å¤åˆ¶ä¸»è‰² ${hex.toUpperCase()}`);
      };
    }

    function renderPalette() {
      paletteDiv.innerHTML = "";
      palette.forEach((rgb) => {
        const hex = rgbToHex(...rgb);
        const textColor = getTextColor(...rgb);

        const block = document.createElement("div");
        block.className = "color-block";
        block.style.backgroundColor = hex;
        block.style.color = textColor;

        const hsv = rgbToHsv(...rgb);
        const lab = rgbToLab(...rgb);

        block.innerHTML =
          `<div><b>HEX:</b> ${hex.toUpperCase()}</div>` +
          `<div><b>RGB:</b> ${rgb.join(", ")}</div>` +
          `<div><b>HSV:</b> ${hsv.map((v) => v.toFixed(1)).join(", ")}</div>` +
          `<div><b>Lab:</b> ${lab.map((v) => v.toFixed(1)).join(", ")}</div>`;

        block.title = "ç‚¹å‡»å¤åˆ¶æ­¤é¢œè‰² HEX";
        block.onclick = () => {
          navigator.clipboard.writeText(hex.toUpperCase());
          alert(`å·²å¤åˆ¶é¢œè‰² ${hex.toUpperCase()}`);
        };

        paletteDiv.appendChild(block);
      });
    }

    // === æå–é¢œè‰²ä¸»æµç¨‹ ===
    function extractColors() {
      if (!previewImage.src) return;
      const count = parseInt(paletteCountInput.value);
      try {
        mainColor = colorThief.getColor(previewImage);
        palette = colorThief.getPalette(previewImage, count);
      } catch (e) {
        alert("æå–å¤±è´¥ï¼Œè¯·ç¡®è®¤å›¾ç‰‡å·²åŠ è½½å®Œæˆä¸”ä¸ºæœ‰æ•ˆå›¾ç‰‡");
        return;
      }
      renderMainColor(mainColor);
      renderPalette();

      mainColorSection.style.display = "block";
      paletteSection.style.display = "block";
    }

    // === Viewer åˆå§‹åŒ– ===
    function initViewer() {
      if (viewer) {
        viewer.destroy();
      }
      viewer = new Viewer(previewImage, {
        navbar: false,
        toolbar: true,
        tooltip: false,
        movable: false,
        zoomable: true,
        scalable: false,
        transition: true,
        fullscreen: false,
      });
    }

    // === è½½å…¥å›¾ç‰‡é€»è¾‘ ===
    function loadImageFromFile(file) {
      if (!file.type.startsWith("image/")) {
        alert("è¯·é€‰æ‹©æœ‰æ•ˆå›¾ç‰‡æ–‡ä»¶");
        return;
      }
      const reader = new FileReader();
      reader.onload = (e) => {
        loadImageSrc(e.target.result);
      };
      reader.readAsDataURL(file);
    }

    function loadImageSrc(src) {
      previewImage.onload = () => {
        imageContainer.style.display = "block";
        countSection.style.display = "block";
        mainColorSection.style.display = "none";
        paletteSection.style.display = "none";
        initViewer();
        extractColors();
        saveHistory(src, mainColor, palette);
      };
      previewImage.onerror = () => {
        alert("å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥é“¾æ¥æˆ–æ–‡ä»¶æ ¼å¼");
        previewImage.src = "";
        imageContainer.style.display = "none";
        countSection.style.display = "none";
        mainColorSection.style.display = "none";
        paletteSection.style.display = "none";
      };
      previewImage.src = src;
    }

    // === æ‹–æ”¾ä¸Šä¼ æ”¯æŒ ===
    uploadArea.addEventListener("click", () => fileInput.click());
    uploadArea.addEventListener("keydown", (e) => {
      if (e.key === "Enter" || e.key === " ") {
        fileInput.click();
      }
    });

    uploadArea.addEventListener("dragover", (e) => {
      e.preventDefault();
      uploadArea.style.borderColor = "var(--primary-color)";
    });
    uploadArea.addEventListener("dragleave", (e) => {
      e.preventDefault();
      uploadArea.style.borderColor = "var(--border-color)";
    });
    uploadArea.addEventListener("drop", (e) => {
      e.preventDefault();
      uploadArea.style.borderColor = "var(--border-color)";
      if (e.dataTransfer.files.length > 0) {
        loadImageFromFile(e.dataTransfer.files[0]);
        fileInput.value = ""; // æ¸…ç©ºé€‰æ‹©æ–‡ä»¶ï¼Œæ”¯æŒå†æ¬¡é€‰åŒä¸€å¼ 
      }
    });

    fileInput.addEventListener("change", (e) => {
      if (e.target.files.length > 0) {
        loadImageFromFile(e.target.files[0]);
        fileInput.value = ""; // æ¸…ç©ºï¼Œæ”¯æŒé‡å¤é€‰åŒä¸€å¼ 
      }
    });

    extractBtn.addEventListener("click", extractColors);

    // === ç²˜è´´é“¾æ¥åŠ è½½å›¾ç‰‡ ===
    loadUrlBtn.addEventListener("click", () => {
      const url = imageUrlInput.value.trim();
      if (!url) {
        alert("è¯·è¾“å…¥å›¾ç‰‡é“¾æ¥");
        return;
      }
      // if (!/^https?:\/\/.+\.(jpg|jpeg|png|gif|bmp|webp|svg)$/i.test(url)) {
      //   if(!url.startsWith("data:image/")){
      //     alert("è¯·è¾“å…¥æœ‰æ•ˆçš„å›¾ç‰‡é“¾æ¥æˆ–æ•°æ®URL");
      //     return;
      //   }
      // }
      loadImageSrc(url);
    });

    // === å¯¼å‡ºJSON ===
    exportJsonBtn.addEventListener("click", () => {
      if (!palette.length) {
        alert("è¯·å…ˆæå–é¢œè‰²");
        return;
      }
      const data = {
        mainColor: rgbToHex(...mainColor),
        palette: palette.map((rgb) => rgbToHex(...rgb)),
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], {
        type: "application/json",
      });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "palette.json";
      a.click();
      URL.revokeObjectURL(a.href);
    });

    // === å¯¼å‡ºPNGè°ƒè‰²æ¿ ===
    exportPngBtn.addEventListener("click", () => {
      if (!palette.length) {
        alert("è¯·å…ˆæå–é¢œè‰²");
        return;
      }
      const canvas = document.createElement("canvas");
      const blockSize = 80;
      canvas.width = blockSize * palette.length;
      canvas.height = blockSize;
      const ctx = canvas.getContext("2d");

      palette.forEach((rgb, i) => {
        ctx.fillStyle = rgbToHex(...rgb);
        ctx.fillRect(i * blockSize, 0, blockSize, blockSize);
      });

      canvas.toBlob((blob) => {
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "palette.png";
        a.click();
        URL.revokeObjectURL(a.href);
      });
    });

    // === å¯¼å‡ºSVGè°ƒè‰²æ¿ ===
    exportSvgBtn.addEventListener("click", () => {
      if (!palette.length) {
        alert("è¯·å…ˆæå–é¢œè‰²");
        return;
      }
      const blockSize = 80;
      const width = blockSize * palette.length;
      const height = blockSize;
      let rects = "";
      palette.forEach((rgb, i) => {
        const hex = rgbToHex(...rgb);
        rects += `<rect x="${i * blockSize}" y="0" width="${blockSize}" height="${blockSize}" fill="${hex}"/>`;
      });
      const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="${width}" height="${height}">${rects}</svg>`;
      const blob = new Blob([svg], { type: "image/svg+xml" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "palette.svg";
      a.click();
      URL.revokeObjectURL(a.href);
    });

    // === å†å²è®°å½•ç®¡ç† ===
    const HISTORY_KEY = "colorExtractorHistory";

    function saveHistory(imageSrc, mainColor, palette) {
      if (!imageSrc || !mainColor || !palette) return;

      const history = getHistory();

      // é™åˆ¶æœ€å¤§å†å²æ¡æ•°ä¸º30
      if (history.length >= 30) {
        history.shift();
      }

      history.push({
        timestamp: Date.now(),
        imageSrc,
        mainColor: rgbToHex(...mainColor),
        palette: palette.map((rgb) => rgbToHex(...rgb)),
      });
      localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
      renderHistory();
    }

    function getHistory() {
      const data = localStorage.getItem(HISTORY_KEY);
      if (!data) return [];
      try {
        return JSON.parse(data);
      } catch {
        return [];
      }
    }

    function renderHistory() {
      const history = getHistory();
      historyListEl.innerHTML = "";

      history.forEach((item, index) => {
        const div = document.createElement("div");
        div.className = "history-item";
        div.title = "ç‚¹å‡»æŸ¥çœ‹æ­¤å†å²è®°å½•";

        const img = document.createElement("img");
        img.src = item.imageSrc;
        img.alt = "å†å²è®°å½•å›¾ç‰‡";

        const paletteWrapper = document.createElement("div");
        paletteWrapper.className = "history-palette";

        item.palette.forEach((hex) => {
          const colorBlock = document.createElement("div");
          colorBlock.className = "history-color-block";
          colorBlock.style.backgroundColor = hex;
          paletteWrapper.appendChild(colorBlock);
        });

        div.appendChild(img);
        div.appendChild(paletteWrapper);

        div.onclick = () => {
          loadImageSrc(item.imageSrc);
          paletteCountInput.value = item.palette.length;
        };

        historyListEl.appendChild(div);
      });
    }

    clearHistoryBtn.addEventListener("click", () => {
      if (confirm("ç¡®å®šæ¸…ç©ºæ‰€æœ‰å†å²è®°å½•å—ï¼Ÿ")) {
        localStorage.removeItem(HISTORY_KEY);
        renderHistory();
      }
    });

    // åˆå§‹åŒ–æ˜¾ç¤ºå†å²è®°å½•
    renderHistory();
  </script>
</body>
</html>
